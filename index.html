<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Symptom Check</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1DB446;
            --bg-color: #f8f9fa;
            --text-color: #333;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            display: none;
            /* Hide all by default */
        }

        h2 {
            text-align: center;
            color: var(--primary-color);
            margin-top: 0;
        }

        h3 {
            margin: 10px 0;
            color: #555;
        }

        p {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }

        /* Views */
        .view-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .view-section.active {
            display: block;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            font-weight: 500;
            display: block;
            margin-bottom: 8px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            cursor: pointer;
        }

        input[type="tel"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Kanit', sans-serif;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 10px;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Profile Card */
        .profile-card {
            text-align: center;
            padding: 20px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .profile-detail {
            text-align: left;
            margin-top: 15px;
            background: white;
            padding: 15px;
            border-radius: 8px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .detail-label {
            font-weight: 600;
            color: #888;
        }

        .detail-value {
            font-weight: 500;
            color: #333;
        }

        /* Loading */
        #loadingView {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>

    <!-- Main Container -->
    <div class="container" id="mainContainer" style="display: block;">

        <!-- View 1: Loading -->
        <div id="loadingView" class="view-section active">
            <div class="spinner"></div>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>

        <!-- View 2: Register (Enter Phone) -->
        <div id="registerView" class="view-section">
            <h2>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</h2>
            <p style="text-align: center; margin-bottom: 20px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å
                ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</p>
            <form id="registerForm">
                <div class="form-group">
                    <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                    <input type="tel" id="phone" name="phone" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 0812345678" required>
                </div>
                <div id="regError" style="color: red; text-align: center; display: none; margin-bottom: 10px;"></div>
                <button type="submit" id="regBtn">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </form>
        </div>

        <!-- View 3: Profile Confirmation -->
        <div id="profileView" class="view-section">
            <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
            <div class="profile-card">
                <div style="font-size: 40px; margin-bottom: 10px;">üìã</div>
                <h3 id="profName">-</h3>
                <p id="profHN">HN: -</p>
                <div class="profile-detail">
                    <div class="detail-row"><span class="detail-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:</span> <span class="detail-value"
                            id="profNick">-</span></div>
                    <div class="detail-row"><span class="detail-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:</span> <span class="detail-value"
                            id="profDOB">-</span></div>
                </div>
            </div>
            <button id="startBtn">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</button>
        </div>

        <!-- View 4: Symptom Form -->
        <div id="formView" class="view-section">
            <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</h2>
            <form id="symptomForm">
                <div class="form-group">
                    <label>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" name="symptoms"
                                value="‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"> ‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                        <label class="checkbox-item"><input type="checkbox" name="symptoms" value="‡∏õ‡∏ß‡∏î/‡∏ö‡∏ß‡∏° ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢">
                            ‡∏õ‡∏ß‡∏î/‡∏ö‡∏ß‡∏° ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</label>
                        <label class="checkbox-item"><input type="checkbox" name="symptoms" value="‡∏°‡∏µ‡∏£‡∏≠‡∏¢‡πÄ‡∏Ç‡πá‡∏°/‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ä‡πâ‡∏≥">
                            ‡∏°‡∏µ‡∏£‡∏≠‡∏¢‡πÄ‡∏Ç‡πá‡∏°/‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ä‡πâ‡∏≥</label>
                        <label class="checkbox-item"><input type="checkbox" name="symptoms" value="‡πÅ‡∏ú‡∏•‡∏°‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ã‡∏∂‡∏°">
                            ‡πÅ‡∏ú‡∏•‡∏°‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ã‡∏∂‡∏°</label>
                        <label class="checkbox-item"><input type="checkbox" name="symptoms" value="‡∏¢‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏°‡∏≠‡∏¢‡∏π‡πà">
                            ‡∏¢‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏°‡∏≠‡∏¢‡∏π‡πà</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="comment">‡∏Ç‡πâ‡∏≠‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <textarea id="comment" name="comment" rows="4" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                </div>
                <button type="submit" id="submitBtn">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </form>
        </div>

        <!-- Success Message -->
        <div id="successView" class="view-section" style="text-align: center;">
            <div style="font-size: 50px; color: var(--primary-color); margin-bottom: 20px;">‚úÖ</div>
            <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</h2>
            <p>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡∏ö</p>
        </div>

        <!-- View 5: Gift / Coupon -->
        <div id="giftView" class="view-section" style="text-align: center;">
            <div style="font-size: 60px; margin-bottom: 20px;">üéÅ</div>
            <h2>‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î!</h2>
            <p>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÑ‡∏ß‡πâ‡∏ß‡∏≤‡∏á‡πÉ‡∏à‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏î‡∏π‡πÅ‡∏•‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏ï‡∏•‡∏≠‡∏î‡∏Ñ‡∏£‡∏±‡∏ö</p>

            <div
                style="background: #f0fdf4; border: 2px dashed #1DB446; padding: 20px; border-radius: 12px; margin: 20px 0;">
                <h3 style="color: #1DB446; margin: 0;">‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 5%</h3>
                <p style="margin-top: 5px; font-size: 12px; color: #888;">‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô 30 ‡∏ß‡∏±‡∏ô</p>
                <div style="margin-top: 15px;">
                    <span style="font-size: 12px; color: #555;">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏:</span>
                    <div id="giftExpiryDate"
                        style="background: white; padding: 10px; margin-top: 5px; font-weight: bold; letter-spacing: 1px; border-radius: 4px; border: 1px solid #ddd; font-size: 18px;">
                        Loading...
                    </div>
                </div>
            </div>

            <p style="font-size: 12px; color: #aaa;">*‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡∏Å‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
            <button onclick="liff.closeWindow()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        const LIFF_ID = "2007784481-qWTVx4hJ";
        const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbwMZKO1ke397xlOaARSZIsWHAUWIvp4_QHWd3K8OZxjb0Ezl7ngdSn_RTdERyyoOi0uIQ/exec"

        // State
        let currentUserId = null;

        // Navigation Helper
        function showView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        // --- 1. INITIALIZATION ---
        window.onload = function () {
            // Check for URL Params (e.g. ?view=gift)
            const urlParams = new URLSearchParams(window.location.search);
            const viewParam = urlParams.get('view');

            liff.init({ liffId: LIFF_ID })
                .then(() => {
                    // Specific View Logic
                    if (viewParam === 'gift') {
                        // Check if Expiry passed from URL
                        const urlParams = new URLSearchParams(window.location.search);
                        const expParam = urlParams.get('exp');

                        if (expParam) {
                            document.getElementById('giftExpiryDate').innerText = expParam;
                        } else {
                            // Fallback: Calculate Expiry Date (Today + 1 Month)
                            const today = new Date();
                            const nextMonth = new Date(today);
                            nextMonth.setMonth(today.getMonth() + 1);

                            // Format Date (Thai)
                            const months = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
                            const day = nextMonth.getDate();
                            const month = months[nextMonth.getMonth()];
                            const year = nextMonth.getFullYear() + 543;

                            document.getElementById('giftExpiryDate').innerText = `${day} ${month} ${year}`;
                        }

                        showView('giftView');
                        return; // Stop here, don't check registration
                    }

                    if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        liff.getProfile().then(profile => {
                            currentUserId = profile.userId;
                            checkRegistrationStatus(profile.userId);
                        });
                    }
                })
                .catch((err) => {
                    console.error('LIFF Init failed', err);
                    // alert('LIFF Error: ' + err); // Suppress alert for cleaner UX if config is missing, but better to show if testing
                    document.getElementById('loadingView').innerHTML = `<p style="color:red">Error: ${err.message}<br>Please check LIFF_ID configuration.</p>`;
                });
        };

        // --- 2. CHECK STATUS ---
        function checkRegistrationStatus(uid) {
            fetch(GAS_EXEC_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'check_status', userId: uid })
            })
                .then(res => res.json())
                .then(data => {
                    if (data && data.registered && data.profile) {
                        // Registered -> Show Profile
                        updateProfileUI(data.profile);
                        showView('profileView');
                    } else {
                        // Not registered -> Show Register
                        showView('registerView');
                    }
                })
                .catch(err => {
                    console.error(err);
                    // Fallback: If error, maybe show register to be safe?
                    alert('Connection Error. Please try refreshing.');
                });
        }

        function updateProfileUI(profile) {
            document.getElementById('profName').innerText = profile.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
            document.getElementById('profHN').innerText = 'HN: ' + (profile.hn || '-');
            document.getElementById('profNick').innerText = profile.nickname || '-';
            document.getElementById('profDOB').innerText = profile.dob || '-';
        }

        // --- 3. HANDLE REGISTRATION SUBMIT ---
        document.getElementById('registerForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const phone = document.getElementById('phone').value;
            const btn = document.getElementById('regBtn');
            const errDiv = document.getElementById('regError');

            btn.disabled = true;
            btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
            errDiv.style.display = 'none';

            fetch(GAS_EXEC_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'register', userId: currentUserId, phone: phone })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.profile) {
                        // Success -> Go to Profile
                        updateProfileUI(data.profile);
                        showView('profileView');
                    } else {
                        // Failed
                        errDiv.innerText = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                        errDiv.style.display = 'block';
                        btn.disabled = false;
                        btn.innerText = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
                    }
                })
                .catch(err => {
                    errDiv.innerText = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                    errDiv.style.display = 'block';
                    btn.disabled = false;
                    btn.innerText = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
                });
        });

        // --- 4. HANDLE PROFILE "START" ---
        document.getElementById('startBtn').addEventListener('click', function () {
            showView('formView');
        });

        // --- 5. HANDLE SYMPTOM SUBMIT ---
        document.getElementById('symptomForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
            btn.disabled = true;

            const formData = new FormData(e.target);
            const data = {
                action: 'submit',
                userId: currentUserId,
                symptoms: formData.getAll('symptoms'),
                comment: formData.get('comment')
            };

            fetch(GAS_EXEC_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(data)
            })
                .then(() => {
                    showView('successView');
                    setTimeout(() => { liff.closeWindow(); }, 3000);
                })
                .catch(error => {
                    alert('Error: ' + error);
                    btn.disabled = false;
       
